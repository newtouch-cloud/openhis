@using Newtouch.Infrastructure;
@{
    ViewBag.Title = "SettlementListResultFrom";
    Layout = "~/Views/Shared/_Index.cshtml";
    var brzybzType = ((int)EnumZYBZ.Djz).ToString();
    var opr = Newtouch.Common.Operator.OperatorProvider.GetCurrent();
}
<form>
    <div class="gridPanel" style="margin-top:1%">
        <table id="gridList"></table>
        @*<div id="gridPager"></div>*@
        <table id="detailGrid"></table>
    </div>
</form>
<script>
    var colModel;
    var zyh = $.request('zyh');
    var $gridList = $("#gridList");
    var $detailGrid = $("#detailGrid");
    $(function () {
        gridListData();
        bindGridList();
        displayDetailInfo([]);
    });
    function bindGridList() {
        colModel = [
            {
                label: '机构编号', name: 'fixmedins_code', align: 'center', width: 90, key: true
            },
            { label: '机构名称', name: 'fixmedins_name', align: 'center', width: 120 },
            { label: '结算年月', name: 'setl_ym', align: 'center', width: 50 },
            { label: '结算 ID', name: 'setl_id', align: 'left', width: 60 },
            { label: '人员编号', name: 'psn_no', align: 'left', width: 130 },
            { label: '人员姓名', name: 'psn_name', align: 'center', width: 50 },
            { label: '质控结果', name: 'qltctrl_rslt', align: 'center', width: 60 },
            { label: ' 错误等级', name: 'err_lv', align: 'center', width: 50 },
            { label: '回退标志', name: 'retn_flag', align: 'center', width: 50 },
            { label: '质控版本号', name: 'qltctrl_ver', align: 'center', width: 50 },
            { label: '人员证件类型', name: 'psn_cert_type', align: 'center', width: 80 },
            { label: '证件号码', name: 'cert_no', align: 'center', width: 100 },

        ];
        $.ajax({
            type: "POST",
            url: "http://127.0.0.1:33333/api/YiBao/QueryQltctrlProblem_4104",//QueryNumMedicalSettlement_4104
            data: { hisId: zyh, operatorId: '@(opr.rygh)', operatorName: '@(opr.UserName)', orgId: '@(opr.OrganizeId)' },
            dataType: "json",
            async: false,
            success: function (data) {
                debugger;
                var tfReturn = eval('(' + data + ')');
                if (tfReturn) {
                    if (tfReturn.infcode == 0 || tfReturn.infcode == "0") {
                        $gridList.newtouchLocalDataGrid({
                            autowidth: false,
                            unwritten: false,
                            caption: "结算清单质控查询",
                            colModel: colModel,
                        }, tfReturn.output.data);
                        // 调用显示详情信息表格的函数
                        displayDetailInfo(tfReturn.output.data[0].detailinfo);
                    }
                    else {
                        $.modalAlert("结算清单质控查询失败：" + tfReturn.err_msg, 'error');
                        return;
                    }
                }
            }, error: function () {
                $.loading(false);
                $.modalAlert("服务异常：", 'error');
                return;
            }
        });

    }
    function gridListData() {
        var $gridList = $("#gridList");
        var captionCon = "质控结果";
        $gridList.dataGrid({
            height: $(window).height() - 300,
            caption: captionCon,
            multiselect: false,
            unwritten: false,
            colModel: [
                {
                    label: '机构编号', name: 'fixmedins_code', align: 'center', width: 90, key: true
                },
                { label: '机构名称', name: 'fixmedins_name', align: 'center', width: 120 },
                { label: '结算年月', name: 'setl_ym', align: 'center', width: 50 },
                { label: '结算 ID', name: 'setl_id', align: 'left', width: 60 },
                { label: '人员编号', name: 'psn_no', align: 'left', width: 130 },
                { label: '人员姓名', name: 'psn_name', align: 'center', width: 50 },
                { label: '质控结果', name: 'qltctrl_rslt', align: 'center', width: 60 },
                { label: ' 错误等级', name: 'err_lv', align: 'center', width: 50 },
                { label: '回退标志', name: 'retn_flag', align: 'center', width: 50 },
                { label: '质控版本号', name: 'qltctrl_ver', align: 'center', width: 50 },
                { label: '人员证件类型', name: 'psn_cert_type', align: 'center', width: 80 },
                { label: '证件号码', name: 'cert_no', align: 'center', width: 100 },

            ],
            //pager: "#gridPager",
            viewrecords: true
        });
    }

    // 显示详情信息的函数
    function displayDetailInfo(detailData) {
        var $detailGrid = $("#detailGrid");
        var detailColModel = [
            { label: '错误等级', name: 'err_lv', align: 'center', width: 50 },
            { label: '质控检查结果', name: 'qltctrl_chk_rslt', align: 'center', width: 150 },
            { label: '初始值', name: 'init_val', align: 'center', width: 50 },
            { label: '检查数据字段', name: 'exam_data_fld', align: 'center', width: 150 },
            { label: '回退标志', name: 'retn_flag', align: 'center', width: 50 }
        ];

        // 创建并填充detailGrid表格
        $detailGrid.newtouchLocalDataGrid({
            autowidth: true,
            unwritten: false,
            caption: "质控详情",
            colModel: detailColModel,
        }, detailData.length > 0 ? detailData : [{/* Empty row to show column headers */ }]);
    }
</script>